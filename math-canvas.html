<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mentora Edge – Apple Level Math Canvas</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- Advanced OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- Advanced Math Engine -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/nerdamer.core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Algebra.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Calculus.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Solve.min.js"></script>

<style>
body{background:#f3f4f6;}
canvas{touch-action:none;}
.tool-btn{
  padding:6px 12px;
  border:1px solid #e5e7eb;
  border-radius:8px;
  background:white;
  cursor:pointer;
}
.tool-btn.active{
  background:#1E40AF;
  color:white;
}
</style>
</head>

<body class="font-sans">

<div class="max-w-5xl mx-auto p-4">

<h1 class="text-2xl font-bold text-blue-800 mb-4">
Mentora Edge – Smart Math Canvas Pro
</h1>

<div class="flex gap-2 mb-3">
<button class="tool-btn active" id="penBtn">Pen</button>
<button class="tool-btn" id="eraserBtn">Eraser</button>
<input type="color" id="colorPicker" value="#000000">
<button class="tool-btn" id="clearBtn">Clear</button>

<label class="ml-4 flex items-center gap-2">
<input type="checkbox" id="stylusOnly"> Stylus Only
</label>
</div>

<div class="bg-white shadow rounded-xl overflow-hidden">
<canvas id="canvas" width="1000" height="500"></canvas>
</div>

</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let drawing=false;
let tool="pen";
let color="#000";

/* ================= GRID ================= */
function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#e5e7eb";
  ctx.lineWidth=1;

  for(let x=0;x<canvas.width;x+=25){
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.height);
    ctx.stroke();
  }
  for(let y=0;y<canvas.height;y+=25){
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
    ctx.stroke();
  }
}
drawGrid();

/* ================= TOOLS ================= */
penBtn.onclick=()=>{tool="pen";setActive(penBtn);};
eraserBtn.onclick=()=>{tool="eraser";setActive(eraserBtn);};
colorPicker.onchange=e=>color=e.target.value;
clearBtn.onclick=drawGrid;

function setActive(btn){
  document.querySelectorAll(".tool-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

/* ================= PALM REJECTION ================= */
let activePen=false;
let activePointerId=null;

function ignore(e){
  const stylusOnly=document.getElementById("stylusOnly").checked;
  if(stylusOnly && e.pointerType!=="pen") return true;
  if(activePen && e.pointerType!=="pen") return true;
  if(e.pointerType==="touch" && !e.isPrimary) return true;
  return false;
}

/* ================= DRAW ================= */
canvas.onpointerdown=e=>{
  if(ignore(e)) return;
  drawing=true;
  activePointerId=e.pointerId;
  if(e.pointerType==="pen") activePen=true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX,e.offsetY);
};

canvas.onpointermove=e=>{
  if(!drawing || e.pointerId!==activePointerId) return;
  if(ignore(e)) return;

  if(tool==="eraser"){
    ctx.globalCompositeOperation="destination-out";
    ctx.lineWidth=20;
  }else{
    ctx.globalCompositeOperation="source-over";
    ctx.strokeStyle=color;
    ctx.lineWidth=3;
  }

  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.stroke();
};

canvas.onpointerup=e=>{
  if(e.pointerId!==activePointerId) return;
  drawing=false;
  activePen=false;
  startIdleTimer();
};

/* ================= AUTO DETECT ================= */
let timer=null;
function startIdleTimer(){
  clearTimeout(timer);
  timer=setTimeout(processCanvas,2500);
}

/* ================= OCR ================= */
async function processCanvas(){

  const img=canvas.toDataURL();

  const {data:{text}} = await Tesseract.recognize(img,'eng',{
    tessedit_char_whitelist:"0123456789xX+-*/=().sincoztan"
  });

  let expr=text
    .replace(/\s/g,"")
    .replace(/×/g,"*")
    .replace(/÷/g,"/")
    .replace(/X/g,"x");

  if(!isMath(expr)) return;

  solveAndAnimate(expr);
}

/* ================= MATH CHECK ================= */
function isMath(str){
  return /[0-9+\-*/=x]/.test(str);
}

/* ================= SOLVER ================= */
function solveAndAnimate(expr){

  drawGrid();

  ctx.fillStyle="#000";
  ctx.font="32px Arial";
  ctx.fillText(expr,50,90);

  setTimeout(()=>{

    let steps=[];
    let final="";

    try{

      if(expr.includes("=")){
        let parts=expr.split("=");
        let eq=parts[0]+"-("+parts[1]+")";

        steps.push("Bring terms to one side");
        let sol=nerdamer.solve(eq,"x").toString();

        steps.push("Solve for x");
        final="x = "+sol;
      }
      else{
        steps.push("Evaluate expression");
        final=nerdamer(expr).toString();
      }

    }catch{
      return;
    }

    animateSteps(steps,final);

  },800);
}

/* ================= ANIMATION ================= */
function animateSteps(steps,final){

  let y=150;
  ctx.fillStyle="#1E40AF";
  ctx.font="26px Arial";

  let i=0;

  function nextStep(){
    if(i<steps.length){
      ctx.fillText("Step "+(i+1)+": "+steps[i],50,y);
      y+=40;
      i++;
      setTimeout(nextStep,800);
    }
    else{
      ctx.font="36px Arial";
      ctx.fillStyle="#059669";
      ctx.fillText("Answer: "+final,50,y+20);
    }
  }

  nextStep();
}

</script>

</body>
</html>