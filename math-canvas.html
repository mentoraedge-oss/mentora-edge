<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mentora Edge Smart Math Canvas</title>

<script src="https://cdn.tailwindcss.com"></script>

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>

<!-- Math Engine -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/nerdamer.core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Algebra.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Calculus.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/nerdamer/1.1.13/Solve.min.js"></script>

<style>
body{background:#f3f4f6;}
canvas{touch-action:none;}

.tool-btn{
  padding:6px 12px;
  border:1px solid #e5e7eb;
  border-radius:8px;
  background:white;
  cursor:pointer;
}
.tool-btn.active{
  background:#1E40AF;
  color:white;
}
</style>
</head>

<body class="font-sans">

<div class="max-w-6xl mx-auto p-4">

<h1 class="text-2xl font-bold text-blue-800 mb-4">
Mentora Edge – Smart Math Canvas
</h1>

<!-- TOOLBAR -->
<div class="flex flex-wrap gap-2 mb-3">
<button class="tool-btn active" id="penBtn">Pen</button>
<button class="tool-btn" id="eraserBtn">Eraser</button>
<button class="tool-btn" id="rulerBtn">Ruler</button>
<button class="tool-btn" id="shapeBtn">Shape</button>

<input type="color" id="colorPicker" value="#000000">

<button class="tool-btn" id="clearBtn">Clear</button>

<label class="flex items-center gap-2 ml-4">
<input type="checkbox" id="stylusOnly">
Stylus Only
</label>
</div>

<!-- CANVAS -->
<div class="bg-white shadow rounded-xl overflow-hidden">
<canvas id="canvas" width="1000" height="500"></canvas>
</div>

<!-- RESULT -->
<div id="resultBox" class="mt-6 hidden bg-white p-4 rounded-xl shadow">
<h2 class="font-bold text-blue-700 mb-2">Step-by-Step Solution</h2>
<div id="solutionText"></div>
</div>

</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const resultBox = document.getElementById("resultBox");
const solutionText = document.getElementById("solutionText");

let tool="pen";
let drawing=false;
let startX=0, startY=0;
let color="#000";

/* ================= GRID BACKGROUND ================= */

function drawGrid(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle="#e5e7eb";
  ctx.lineWidth=1;

  for(let x=0;x<canvas.width;x+=25){
    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,canvas.height);
    ctx.stroke();
  }

  for(let y=0;y<canvas.height;y+=25){
    ctx.beginPath();
    ctx.moveTo(0,y);
    ctx.lineTo(canvas.width,y);
    ctx.stroke();
  }
}
drawGrid();

/* ================= TOOL SELECTION ================= */

function setTool(t,btn){
  tool=t;
  document.querySelectorAll(".tool-btn").forEach(b=>b.classList.remove("active"));
  btn.classList.add("active");
}

penBtn.onclick=()=>setTool("pen",penBtn);
eraserBtn.onclick=()=>setTool("eraser",eraserBtn);
rulerBtn.onclick=()=>setTool("ruler",rulerBtn);
shapeBtn.onclick=()=>setTool("shape",shapeBtn);
colorPicker.onchange=e=>color=e.target.value;

clearBtn.onclick=()=>{
  drawGrid();
  resultBox.classList.add("hidden");
};

/* ================= PALM REJECTION ================= */

let activePen=false;
let activePointerId=null;

function ignore(e){
  const stylusOnly=document.getElementById("stylusOnly").checked;
  if(stylusOnly && e.pointerType!=="pen") return true;
  if(activePen && e.pointerType!=="pen") return true;
  if(e.pointerType==="touch" && !e.isPrimary) return true;
  return false;
}

/* ================= DRAWING ================= */

canvas.onpointerdown=e=>{
  if(ignore(e)) return;
  drawing=true;
  startX=e.offsetX;
  startY=e.offsetY;
  activePointerId=e.pointerId;
  if(e.pointerType==="pen") activePen=true;

  ctx.beginPath();
  ctx.moveTo(startX,startY);
};

canvas.onpointermove=e=>{
  if(!drawing || e.pointerId!==activePointerId) return;
  if(ignore(e)) return;

  if(tool==="pen"){
    ctx.strokeStyle=color;
    ctx.lineWidth=3;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
  }

  if(tool==="eraser"){
    ctx.globalCompositeOperation="destination-out";
    ctx.lineWidth=20;
    ctx.lineTo(e.offsetX,e.offsetY);
    ctx.stroke();
    ctx.globalCompositeOperation="source-over";
  }
};

canvas.onpointerup=e=>{
  if(e.pointerId!==activePointerId) return;
  drawing=false;
  activePen=false;

  if(tool==="ruler"){
    drawStraightLine(startX,startY,e.offsetX,e.offsetY);
  }

  if(tool==="shape"){
    detectShape(startX,startY,e.offsetX,e.offsetY);
  }

  startIdleTimer();
};

/* ================= RULER ================= */

function drawStraightLine(x1,y1,x2,y2){
  ctx.strokeStyle=color;
  ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
}

/* ================= SHAPE DETECTION ================= */

function detectShape(x1,y1,x2,y2){
  const w=x2-x1;
  const h=y2-y1;

  ctx.strokeStyle=color;
  ctx.lineWidth=3;

  // Rectangle
  if(Math.abs(w)>20 && Math.abs(h)>20){
    ctx.strokeRect(x1,y1,w,h);
    return;
  }

  // Circle (if near square)
  if(Math.abs(Math.abs(w)-Math.abs(h))<20){
    const r=Math.abs(w)/2;
    ctx.beginPath();
    ctx.arc(x1+r,y1+r,r,0,Math.PI*2);
    ctx.stroke();
    return;
  }
}

/* ================= AUTO SOLVE ================= */

let timer=null;

function startIdleTimer(){
  clearTimeout(timer);
  timer=setTimeout(processCanvas,3000);
}

/* ================= OCR ================= */

async function processCanvas(){
  resultBox.classList.remove("hidden");
  solutionText.innerHTML="Reading problem...";

  const img=canvas.toDataURL();

  const {data:{text}} = await Tesseract.recognize(img,'eng');

  let expr=text
    .replace(/\n/g,";")
    .replace(/\s/g,"")
    .replace(/×/g,"*")
    .replace(/÷/g,"/")
    .replace(/X/g,"x");

  if(!isMath(expr)){
    resultBox.classList.add("hidden");
    return;
  }

  solveMulti(expr);
}

/* ================= MATH CHECK ================= */

function isMath(str){
  return /[0-9x+\-*/=().^]/.test(str);
}

/* ================= MULTI-LINE SOLVER ================= */

function solveMulti(text){
  const lines=text.split(";");
  let output="";

  lines.forEach(line=>{
    if(!line) return;
    output+=solveWithSteps(line)+"<br><br>";
  });

  solutionText.innerHTML=output;
}

/* ================= STEP-BY-STEP SOLVER ================= */

function solveWithSteps(expr){
  try{
    let steps="<b>Problem:</b> "+expr+"<br>";

    if(expr.includes("=")){
      const parts=expr.split("=");
      steps+="Step 1: Move all terms to one side<br>";

      const eq=parts[0]+"-("+parts[1]+")";
      steps+="Step 2: Simplify equation → "+eq+" = 0<br>";

      const sol=nerdamer.solve(eq,"x");

      steps+="Step 3: Solve for x<br>";
      steps+="<b>Answer:</b> x = "+sol;
    }
    else{
      const res=nerdamer(expr).toString();
      steps+="Step 1: Evaluate expression<br>";
      steps+="<b>Answer:</b> "+res;
    }

    return steps;

  }catch{
    return "";
  }
}

</script>

</body>
</html>