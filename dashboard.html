<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard | Mentora Edge</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: {
            primary: '#1E40AF',
            accent: '#2563EB'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-100 font-inter text-gray-800">

<header class="bg-white shadow-sm sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-extrabold text-primary">Mentora Edge</h1>
    <button id="logoutBtn" class="text-sm font-semibold text-red-600 hover:underline">
      Logout
    </button>
  </div>
</header>

<main class="max-w-6xl mx-auto px-6 py-10">
  <h1 class="text-3xl font-extrabold mb-8">Student Dashboard</h1>

  <div class="bg-white rounded-2xl shadow-lg p-6">

    <!-- HEADER -->
    <div class="flex justify-between mb-6">
      <div>
        <h2 class="text-xl font-semibold">
          Welcome, <span id="studentName">Student</span>
        </h2>
        <p class="text-sm text-gray-500">Mentora Edge â€¢ Student Portal</p>
      </div>

      <span id="studentStatus"
        class="px-4 py-1.5 rounded-full text-sm font-semibold bg-yellow-100 text-yellow-800">
        Pending
      </span>
    </div>

    <hr class="my-6">

    <!-- INFO -->
    <div class="grid md:grid-cols-2 gap-6">
      <div class="info-card"><span>ğŸ‘¤</span><div><p>Name</p><strong id="studentNameInfo"></strong></div></div>
      <div class="info-card"><span>ğŸ“</span><div><p>Class</p><strong id="studentClass"></strong></div></div>
      <div class="info-card"><span>ğŸ“˜</span><div><p>Subject</p><strong id="studentSubject"></strong></div></div>
      <div class="info-card"><span>â³</span><div><p>Status</p><strong id="studentStatusText"></strong></div></div>
    </div>

    <!-- ANNOUNCEMENTS -->
    <div id="announcementSection" class="hidden mt-10 bg-blue-50 border border-blue-200 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-4">ğŸ“¢ Global Announcements</h3>
      <div id="announcementList" class="space-y-3"></div>
    </div>

    <!-- STUDY MATERIALS -->
    <div id="materialsSection" class="hidden mt-10 bg-gray-50 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-6">ğŸ“š Study Materials</h3>
      <div id="materialsList" class="grid md:grid-cols-2 gap-6"></div>
    </div>

    <!-- FEES -->
    <div id="feesSection" class="hidden mt-10 bg-gray-50 rounded-2xl p-6">
      <h3 class="text-xl font-bold mb-6">ğŸ’° Monthly Fees Status (2026)</h3>
      <div id="feesContainer" class="grid md:grid-cols-3 gap-4"></div>
    </div>

  </div>
</main>

<script type="module">
import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  doc, getDoc,
  collection, getDocs,
  query, where, orderBy, limit
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

logoutBtn.onclick = async () => {
  await signOut(auth);
  location.href = "login.html";
};

function formatPaidOn(ts) {
  const d = ts.toDate();
  const day = d.getDate();
  const suffix =
    day % 10 === 1 && day !== 11 ? "st" :
    day % 10 === 2 && day !== 12 ? "nd" :
    day % 10 === 3 && day !== 13 ? "rd" : "th";

  const datePart = d.toLocaleDateString("en-IN", {
    month: "long",
    year: "numeric"
  });

  const timePart = d.toLocaleTimeString("en-IN", {
    hour: "numeric",
    minute: "2-digit",
    hour12: true
  });

  return `Paid on ${day}${suffix} ${datePart} at ${timePart}`;
}

/* ANNOUNCEMENTS */
async function loadAnnouncements() {
  const q = query(
    collection(db, "announcements"),
    orderBy("createdAt", "desc"),
    limit(3)
  );

  const snap = await getDocs(q);
  if (snap.empty) return;

  announcementSection.classList.remove("hidden");
  announcementList.innerHTML = "";

  snap.forEach(d => {
    announcementList.innerHTML += `
      <div class="bg-white border rounded-lg p-4 shadow-sm">
        <p class="text-sm">${d.data().text}</p>
      </div>`;
  });
}

/* MATERIALS */
async function loadMaterials(studentClass) {
  const q = query(collection(db, "materials"), where("class", "==", studentClass));
  const snap = await getDocs(q);
  materialsList.innerHTML = "";

  snap.forEach(d => {
    const m = d.data();
    materialsList.innerHTML += `
      <div class="bg-white rounded-xl p-5 shadow">
        <h4 class="font-semibold mb-2">${m.title}</h4>
        <a href="${m.fileURL}" target="_blank"
          class="text-primary text-sm font-medium hover:underline">
          Download â†’
        </a>
      </div>`;
  });

  if (snap.empty) {
    materialsList.innerHTML = `<p class="text-gray-500">No materials uploaded yet.</p>`;
  }
}

/* FEES â€” ONLY 2026 */
async function loadFees(uid) {
  feesContainer.innerHTML = "";
  const snap = await getDoc(doc(db, "users", uid));
  const fees = snap.data().fees?.["2026"];

  if (!fees) {
    feesContainer.innerHTML = `<p class="text-gray-500">No fee records for 2026.</p>`;
    return;
  }

  const months = [
    "January","February","March","April","May","June",
    "July","August","September","October","November","December"
  ];

  months.forEach(month => {
    const m = fees[month];
    const paid = m?.paid === true;

    feesContainer.innerHTML += `
      <div class="bg-white rounded-xl p-4 border">
        <p class="font-semibold">${month}</p>
        <p class="text-sm ${paid ? "text-green-600" : "text-red-600"}">
          ${paid ? "Paid âœ”" : "Not Paid âœ–"}
        </p>
        ${paid && m.paidOn ? `<p class="text-xs text-gray-500">${formatPaidOn(m.paidOn)}</p>` : ""}
      </div>`;
  });
}

/* AUTH */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";

  const snap = await getDoc(doc(db, "users", user.uid));
  const data = snap.data();

  studentName.innerText = data.name;
  studentNameInfo.innerText = data.name;
  studentClass.innerText = data.class;
  studentSubject.innerText = data.subject;
  studentStatusText.innerText = data.status;

  if (data.status === "active") {
    studentStatus.innerText = "Active";
    studentStatus.className =
      "px-4 py-1.5 rounded-full text-sm font-semibold bg-green-100 text-green-800";

    announcementSection.classList.remove("hidden");
    materialsSection.classList.remove("hidden");
    feesSection.classList.remove("hidden");

    await loadAnnouncements();
    await loadMaterials(data.class);
    await loadFees(user.uid);
  }
});
</script>

<style>
.info-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: #f9fafb;
  padding: 1rem;
  border-radius: 1rem;
}
.info-card span { font-size: 1.5rem; }
.info-card p { font-size: 0.75rem; color: #6b7280; }
</style>

</body>
</html>