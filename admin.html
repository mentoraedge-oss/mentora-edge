<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="/manifest.json">
<meta name="theme-color" content="#1E40AF">
<link rel="apple-touch-icon" href="/icons/ios/180.png">
<title>Admin Panel | Mentora Edge</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<script>
tailwind.config = {
  theme: {
    extend: {
      fontFamily: { inter: ['Inter', 'sans-serif'] },
      colors: { primary: '#1E40AF', accent: '#2563EB' }
    }
  }
}
</script>
</head>

<body class="bg-gray-100 font-inter text-gray-800">

<header class="bg-white shadow sticky top-0 z-40">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between">
    <h1 class="text-xl font-extrabold text-primary">Mentora Edge â€” Admin Panel</h1>
    <button id="logoutBtn" class="text-red-600 font-semibold">Logout</button>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-10 space-y-12">

<!-- ANNOUNCEMENT -->
<section class="bg-white p-6 rounded-xl shadow">
  <h2 class="font-bold mb-4">ğŸ“¢ Global Announcement</h2>
  <textarea id="announcementText" class="w-full border rounded p-3" rows="4"></textarea>
  <div class="text-right mt-3">
    <button id="publishAnnouncementBtn" class="bg-primary text-white px-5 py-2 rounded">
      Publish
    </button>
  </div>
</section>

<!-- MATERIAL UPLOAD -->
<section class="bg-white p-6 rounded-xl shadow">
  <h2 class="font-bold mb-4">ğŸ“š Upload Study Material</h2>
  <div class="grid md:grid-cols-4 gap-4">
    <select id="materialClass" class="border p-2 rounded">
      <option value="">Class</option>
      <option value="VIII">VIII</option>
      <option value="IX">IX</option>
      <option value="X">X</option>
    </select>
    <input id="materialTitle" class="border p-2 rounded" placeholder="Title">
    <input id="materialFile" type="file">
    <button id="uploadMaterialBtn" class="bg-primary text-white rounded px-4">
      Upload
    </button>
  </div>
</section>

<!-- STUDENT APPROVAL -->
<section class="bg-white rounded-xl shadow overflow-hidden">
  <h2 class="font-bold px-6 py-4 border-b">ğŸ‘¥ Student Approvals</h2>
  <table class="w-full text-sm">
    <thead class="bg-gray-50">
      <tr>
        <th class="px-6 py-3 text-left">Name</th>
        <th>Email</th>
        <th>Class</th>
        <th>Status</th>
        <th>Student ID</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="studentsTable"></tbody>
  </table>
</section>

<!-- FEES -->
<section class="bg-white p-6 rounded-xl shadow">
  <h2 class="font-bold mb-4">ğŸ’° Monthly Fees Management</h2>
  <div class="flex gap-4 mb-4">
    <select id="feeStudent" class="border p-2 rounded"></select>
    <button id="showFeesBtn" class="bg-primary text-white px-4 rounded">
      Show Fee Status
    </button>
  </div>
  <div id="feesGrid" class="grid md:grid-cols-3 gap-4"></div>
</section>

</main>

<script type="module">
import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut } from
  "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  collection, getDocs, doc, getDoc,
  addDoc, updateDoc, deleteDoc, setDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

import {
  getStorage, ref, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const storage = getStorage();
const studentsTable = document.getElementById("studentsTable");
const feeStudent = document.getElementById("feeStudent");
const feesGrid = document.getElementById("feesGrid");

const months = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";
  const snap = await getDoc(doc(db,"users",user.uid));
  if (snap.data().role !== "admin") return location.href="login.html";

  loadStudents();
  loadFeeStudents();
});

/* STUDENT ID GENERATOR */
async function getNextStudentId() {
  const snap = await getDocs(collection(db, "users"));
  let max = 0;

  snap.forEach(d => {
    const id = d.data().studentId;
    if (id && id.startsWith("ME")) {
      const num = parseInt(id.replace("ME",""));
      if (num > max) max = num;
    }
  });

  return "ME" + String(max + 1).padStart(4,"0");
}

/* STUDENTS */
async function loadStudents(){
  studentsTable.innerHTML="";
  const snap = await getDocs(collection(db,"users"));

  snap.forEach(d=>{
    const u = d.data();
    if(u.role !== "student") return;

    studentsTable.innerHTML += `
      <tr>
        <td class="px-6 py-3">${u.name}</td>
        <td>${u.email}</td>
        <td>${u.class}</td>
        <td>${u.status}</td>
        <td class="font-mono">${u.studentId || "-"}</td>
        <td class="space-x-3">
          ${
            u.status === "pending"
            ? `
              <button onclick="approve('${d.id}')" class="text-green-600">Approve</button>
              <button onclick="rejectStudent('${d.id}')" class="text-red-600">Reject</button>
            `
            : `
              ${!u.studentId
                ? `<button onclick="generateId('${d.id}')" class="text-blue-600">Generate ID</button>`
                : ""
              }
              <button onclick="removeStudent('${d.id}')" class="text-red-600">Remove</button>
            `
          }
        </td>
      </tr>`;
  });
}

/* ğŸ”‘ GENERATE ID + CREATE VERIFICATION RECORD */
window.generateId = async (uid) => {
  const userRef = doc(db,"users",uid);
  const snap = await getDoc(userRef);
  const u = snap.data();

  const studentId = await getNextStudentId();

  // Save in users
  await updateDoc(userRef,{ studentId });

  // Create public verification record
  await setDoc(doc(db,"studentVerifications", studentId), {
    studentId,
    name: u.name,
    class: u.class,
    fatherName: u.fatherName || "",
    motherName: u.motherName || "",
    verifiedAt: serverTimestamp()
  });

  alert("Student ID generated: " + studentId);
  loadStudents();
};

window.approve = async (id) => {
  await updateDoc(doc(db,"users",id), { status:"active" });
  loadStudents();
};

window.rejectStudent = async (id) => {
  if(!confirm("Reject student permanently?")) return;
  await deleteDoc(doc(db,"users",id));
  loadStudents();
};

window.removeStudent = async (id) => {
  if(!confirm("Remove student permanently?")) return;
  await deleteDoc(doc(db,"users",id));
  loadStudents();
};

/* FEES */
async function loadFeeStudents(){
  feeStudent.innerHTML="<option value=''>Select Student</option>";
  const snap=await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    if(d.data().role==="student"){
      feeStudent.innerHTML+=`<option value="${d.id}">${d.data().name}</option>`;
    }
  });
}

showFeesBtn.onclick = async () => {
  if(!feeStudent.value) return alert("Select a student");
  feesGrid.innerHTML="";

  const snap = await getDoc(doc(db,"users",feeStudent.value));
  const fees = snap.data().fees?.["2026"] || {};

  months.forEach(m=>{
    const paid = fees[m]?.paid === true;
    feesGrid.innerHTML += `
      <div class="border rounded p-4 flex justify-between">
        <div>
          <p class="font-semibold">${m}</p>
          <p class="${paid?"text-green-600":"text-red-600"} text-sm">
            ${paid?"Paid":"Not Paid"}
          </p>
        </div>
        ${paid ? "âœ”ï¸" : `<button onclick="markPaid('${m}')" class="text-primary text-sm">Mark Paid</button>`}
      </div>`;
  });
};

window.markPaid = async (month)=>{
  const refUser = doc(db,"users",feeStudent.value);
  const snap = await getDoc(refUser);
  const fees = snap.data().fees || {};
  fees["2026"] = fees["2026"] || {};
  fees["2026"][month] = { paid:true, paidOn:serverTimestamp() };
  await updateDoc(refUser,{ fees });
  showFeesBtn.click();
};

/* ANNOUNCEMENT */
publishAnnouncementBtn.onclick = async () => {
  if(!announcementText.value.trim()) return alert("Empty announcement");
  await addDoc(collection(db,"announcements"),{
    text:announcementText.value,
    createdAt:serverTimestamp()
  });
  announcementText.value="";
  alert("Announcement published");
};

/* MATERIAL UPLOAD */
uploadMaterialBtn.onclick = async () => {
  if(!materialClass.value || !materialTitle.value || !materialFile.files[0]){
    alert("Fill all fields"); return;
  }
  uploadMaterialBtn.disabled=true;
  const file = materialFile.files[0];
  const storageRef = ref(storage, `materials/${Date.now()}_${file.name}`);
  await uploadBytes(storageRef,file);
  const url = await getDownloadURL(storageRef);
  await addDoc(collection(db,"materials"),{
    title: materialTitle.value,
    class: materialClass.value,
    fileURL: url,
    createdAt: serverTimestamp()
  });
  uploadMaterialBtn.disabled=false;
  materialClass.value=""; materialTitle.value=""; materialFile.value="";
  alert("Material uploaded");
};

/* LOGOUT */
logoutBtn.onclick = async()=>{
  await signOut(auth);
  location.href="login.html";
};
</script>

</body>
</html>