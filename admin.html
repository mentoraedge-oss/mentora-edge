<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Panel | Mentora Edge</title>

  <link rel="icon" href="favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { inter: ['Inter', 'sans-serif'] },
          colors: {
            primary: '#1E40AF',
            accent: '#2563EB'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-gray-100 font-inter text-gray-800">

<header class="bg-white sticky top-0 z-40 shadow-sm">
  <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
    <h1 class="text-xl font-extrabold text-primary">
      Mentora Edge <span class="text-gray-400 font-medium">‚Äî Admin Panel</span>
    </h1>
    <button id="logoutBtn" class="text-sm font-semibold text-red-600 hover:underline">
      Logout
    </button>
  </div>
</header>

<main class="max-w-7xl mx-auto px-6 py-10 space-y-14">

<!-- ================= ANNOUNCEMENT ================= -->
<section class="bg-white rounded-2xl shadow border p-6">
  <h2 class="text-xl font-bold mb-4">üì¢ Global Announcement</h2>

  <textarea id="announcementText" rows="4"
    class="w-full border rounded-xl p-4 focus:ring-2 focus:ring-primary"
    placeholder="Type announcement..."></textarea>

  <div class="flex justify-end mt-4">
    <button id="publishAnnouncementBtn"
      class="bg-primary text-white px-6 py-2 rounded-lg font-semibold hover:bg-accent">
      Publish
    </button>
  </div>
</section>

<!-- ================= STUDY MATERIAL ================= -->
<section class="bg-white rounded-2xl shadow border p-6">
  <h2 class="text-xl font-bold mb-6">üìö Upload Study Material</h2>

  <div class="grid md:grid-cols-4 gap-4 items-end">
    <select id="materialClass" class="input">
      <option value="">Class</option>
      <option value="VIII">VIII</option>
      <option value="IX">IX</option>
      <option value="X">X</option>
    </select>

    <input id="materialTitle" class="input" placeholder="Title">
    <input id="materialFile" type="file" class="text-sm">

    <button id="uploadMaterialBtn"
      class="bg-primary text-white rounded-lg py-2 font-semibold hover:bg-accent">
      Upload
    </button>
  </div>
</section>

<!-- ================= STUDENT APPROVALS ================= -->
<section class="bg-white rounded-2xl shadow border overflow-hidden">
  <h2 class="text-xl font-bold px-6 py-4 border-b">üë• Student Approvals</h2>

  <table class="min-w-full text-sm">
    <thead class="bg-gray-50 text-xs uppercase">
      <tr>
        <th class="px-6 py-3 text-left">Name</th>
        <th class="px-6 py-3 text-left">Email</th>
        <th class="px-6 py-3 text-center">Class</th>
        <th class="px-6 py-3 text-center">Status</th>
        <th class="px-6 py-3 text-center">Action</th>
      </tr>
    </thead>
    <tbody id="studentsTable" class="divide-y"></tbody>
  </table>
</section>

<!-- ================= FEES MANAGEMENT ================= -->
<section class="bg-white rounded-2xl shadow border p-6">
  <h2 class="text-xl font-bold mb-6">üí∞ Monthly Fees Management</h2>

  <div class="flex flex-wrap gap-4 items-end mb-6">
    <select id="feeStudent" class="input w-64">
      <option value="">Select Student</option>
    </select>

    <select id="feeYear" class="input w-40">
      <option value="2026">2026</option>
      <option value="2025">2025</option>
    </select>

    <button
      id="showFeesBtn"
      class="bg-primary text-white px-5 py-2 rounded-lg font-semibold hover:bg-accent">
      Show Fee Status
    </button>
  </div>

  <div id="feesGrid" class="grid md:grid-cols-3 gap-4"></div>
</section>

</main>

<!-- ================= SCRIPT ================= -->
<script type="module">
import { auth, db } from "./js/firebase.js";
import { onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

import {
  collection, getDocs, doc, getDoc,
  updateDoc, addDoc, serverTimestamp, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const months = [
  "January","February","March","April","May","June",
  "July","August","September","October","November","December"
];

const studentsTable = document.getElementById("studentsTable");
const feeStudent = document.getElementById("feeStudent");
const feeYear = document.getElementById("feeYear");
const feesGrid = document.getElementById("feesGrid");
const showFeesBtn = document.getElementById("showFeesBtn");

/* ================= AUTH ================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) return location.href = "login.html";
  const snap = await getDoc(doc(db,"users",user.uid));
  if (!snap.exists() || snap.data().role !== "admin") {
    await signOut(auth);
    return location.href = "login.html";
  }

  loadApprovalStudents();
  loadFeeStudents();
});

/* ================= STUDENT APPROVALS ================= */
async function loadApprovalStudents(){
  studentsTable.innerHTML = "";
  const snap = await getDocs(collection(db,"users"));

  snap.forEach(d=>{
    const u = d.data();
    if(u.role !== "student") return;

    studentsTable.innerHTML += `
      <tr>
        <td class="px-6 py-3">${u.name}</td>
        <td class="px-6 py-3">${u.email}</td>
        <td class="px-6 py-3 text-center">${u.class}</td>
        <td class="px-6 py-3 text-center">${u.status}</td>
        <td class="px-6 py-3 text-center">
          ${
            u.status === "pending"
            ? `<button class="text-green-600 font-semibold"
                onclick="approveStudent('${d.id}')">Approve</button>`
            : "‚Äî"
          }
        </td>
      </tr>
    `;
  });
}

window.approveStudent = async (id)=>{
  await updateDoc(doc(db,"users",id),{ status:"active" });
  loadApprovalStudents();
};

/* ================= FEES ================= */
async function loadFeeStudents(){
  feeStudent.innerHTML = `<option value="">Select Student</option>`;
  const snap = await getDocs(collection(db,"users"));
  snap.forEach(d=>{
    if(d.data().role==="student"){
      feeStudent.innerHTML += `<option value="${d.id}">${d.data().name}</option>`;
    }
  });
}

showFeesBtn.onclick = loadFees;

async function loadFees(){
  if(!feeStudent.value) {
    alert("Please select a student");
    return;
  }

  feesGrid.innerHTML = "";

  for(const month of months){
    const ref = doc(db,"users",feeStudent.value,"fees",feeYear.value,month);
    const snap = await getDoc(ref);
    const paid = snap.exists() && snap.data().paid === true;

    feesGrid.innerHTML += `
      <div class="border rounded-xl p-4 flex justify-between items-center">
        <div>
          <p class="font-semibold">${month}</p>
          <p class="text-sm ${paid ? "text-green-600" : "text-red-500"}">
            ${paid ? "Paid" : "Not Paid"}
          </p>
        </div>
        ${
          paid
          ? "‚úîÔ∏è"
          : `<button class="text-sm text-primary font-semibold"
              onclick="markPaid('${month}')">Mark Paid</button>`
        }
      </div>
    `;
  }
}

window.markPaid = async (month)=>{
  const ref = doc(db,"users",feeStudent.value,"fees",feeYear.value,month);
  await setDoc(ref,{ paid:true, paidOn:serverTimestamp() });
  loadFees();
};

/* ================= LOGOUT ================= */
logoutBtn.onclick = async()=>{
  await signOut(auth);
  location.href="login.html";
};
</script>

<style>
.input{
  padding:.6rem;
  border:1px solid #D1D5DB;
  border-radius:.6rem;
}
</style>

</body>
</html>
